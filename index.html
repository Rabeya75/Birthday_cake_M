<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy Birthday monohorin</title>

    <style>
        /* --- General and UI Styles --- */
        body {
            background-color: #FEDFED;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }

        #title-message {
            font-family: cursive;
            color: #8C0303;
            text-align: center;
            margin-bottom: 20px;
            font-size: 2.5em; /* Slightly larger text */
        }

        .controls-overlay {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 8px;
            z-index: 100;
            text-align: center;
        }

        .controls-overlay h3 {
            margin-top: 0;
            margin-bottom: 5px;
        }

        #startButton {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 10px;
        }

        #blow-status {
            color: #FFD700;
            font-weight: bold;
            font-size: 1.2em;
            margin-top: 10px;
        }
        
        input[type="file"] {
            display: block;
            margin: 5px auto;
            font-size: 0.9em;
            color: white;
            background-color: transparent;
            border: 1px solid white;
            padding: 5px;
            border-radius: 3px;
        }

        /* --- Cake and Candle Styles (Adapted from source link) --- */
        
        .cake {
            position: relative;
            cursor: pointer;
            transform: scale(1.5); /* MAKE THE CAKE LARGER */
        }

        /* Plate */
        .plate {
            width: 300px;
            height: 10px;
            background-color: #eee;
            border-radius: 50%;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: -5px;
            box-shadow: 0 5px 0px #ccc;
        }

        /* Cake Layers */
        .layer {
            width: 200px;
            height: 50px;
            position: relative;
            background-color: #FCD7BA; /* Vanilla color */
            border-radius: 5px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 2px 0px #F5C5A1, 0 4px 0px #EDB486, 0 6px 0px #E5A36B, 0 8px 0px #DE9251;
        }

        .layer-bottom { bottom: 60px; }
        .layer-middle { bottom: 110px; }
        .layer-top { bottom: 160px; }

        /* Icing */
        .icing {
            width: 200px;
            height: 10px;
            background-color: #FFDAB9; /* Icing color */
            border-radius: 50%;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 170px;
            box-shadow: 0 2px 0px #FCD7BA;
        }

        /* Drips */
        .drip1, .drip2, .drip3 {
            position: absolute;
            width: 10px;
            height: 20px;
            background-color: #FCD7BA;
            border-radius: 0 0 50% 50%;
            bottom: 150px;
        }
        .drip1 { left: 55px; }
        .drip2 { left: 95px; }
        .drip3 { left: 135px; }

        /* Candle Counter */
        .candle-count-display {
            position: absolute;
            bottom: 200px;
            left: 50%;
            transform: translateX(-50%);
            color: #8C0303;
            font-weight: bold;
            z-index: 10;
        }

        /* Candle and Flame */
        .candle {
            position: absolute;
            width: 5px;
            height: 30px;
            background-color: #FF0000;
            border-radius: 2px;
            z-index: 5;
            bottom: 180px;
            /* transform will be set by JS on click */
        }
        
        .flame {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 5px;
            height: 10px;
            background: radial-gradient(circle at 50% 0, yellow, orange, transparent 70%);
            border-radius: 50% 50% 20% 20%;
            box-shadow: 0 0 5px 2px yellow;
            animation: flicker 0.2s infinite alternate;
        }
        
        /* State when candle is blown out */
        .candle.out .flame {
            display: none;
        }

        @keyframes flicker {
            from { opacity: 1; box-shadow: 0 0 5px 2px orange; }
            to { opacity: 0.8; box-shadow: 0 0 4px 1px yellow; }
        }

    </style>
</head>
<body>
    
    <h1 id="title-message">Happy Birthday monohorin</h1>
    
    <div id="cake-container">
        <div class="cake">
            <div class="plate"></div>
            <div class="layer layer-bottom"></div>
            <div class="layer layer-middle"></div>
            <div class="layer layer-top"></div>
            <div class="icing"></div>
            <div class="drip drip1"></div>
            <div class="drip drip2"></div>
            <div class="drip drip3"></div>
            <div class="candle-count-display">Candles: <span id="candleCount">0</span></div>
        </div>
    </div>

    <div class="controls-overlay">
        <p id="mic-status">Click START to begin...</p>
        <button id="startButton">START Interaction (Allow Mic)</button>
        <p id="blow-status" style="display:none;">BLOW NOW!</p>
        
        <hr style="width:100%; border-color: rgba(255,255,255,0.2);">
        
        <h3>Voice Message</h3>
        <input type="file" id="audioUpload" accept="audio/*">
        <p id="audio-status" style="font-size:0.9em; margin: 0;">No audio uploaded.</p>
    </div>
    
    <audio id="birthdayMessageAudio"></audio>
    <audio id="backgroundMusic" src="[path/to/your/music.mp3]" loop autoplay></audio> 
    <script>
        // --- DOM Elements and Core Variables ---
        const cake = document.querySelector(".cake");
        const candleCountDisplay = document.getElementById("candleCount");
        const backgroundMusic = document.getElementById("backgroundMusic");
        const startButton = document.getElementById("startButton");
        const micStatus = document.getElementById("mic-status");
        const blowStatus = document.getElementById("blow-status");
        const audioUpload = document.getElementById("audioUpload");
        const audioStatus = document.getElementById("audio-status");
        const birthdayMessageAudio = document.getElementById("birthdayMessageAudio");

        let candles = [];
        let audioContext;
        let analyser;
        let microphone;

        const BLOW_THRESHOLD = 150; // Sensitivity for blow detection (Adjust this!)
        let isBlowing = false;

        // --- Functions ---
        
        function updateCandleCount() {
            const activeCandles = candles.filter((candle) => !candle.classList.contains("out")).length;
            candleCountDisplay.textContent = activeCandles;

            if (activeCandles === 0 && candles.length > 0) {
                handleBlowOut();
            }
        }

        function handleBlowOut() {
            // 1. Stop background music
            backgroundMusic.pause();
            
            // 2. Play recorded message
            if (birthdayMessageAudio.src) {
                birthdayMessageAudio.play();
            }
            
            // 3. Update UI
            micStatus.textContent = "WISH GRANTED! Message Playing... ðŸŽ‰";
            blowStatus.style.display = 'block';
            blowStatus.textContent = 'HAPPY BIRTHDAY!';
        }

        // --- Event Listeners ---
        
        // 1. Add Candle (Click on Cake)
        cake.addEventListener("click", function (e) {
            if (!audioContext) {
                alert("Please click 'START Interaction' first to enable microphone.");
                return;
            }
            
            const rect = cake.getBoundingClientRect();
            // Calculate relative position within the cake div
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const candle = document.createElement("div");
            candle.className = "candle";
            // Adjust position to place the candle on the top layer
            candle.style.left = x + "px";
            candle.style.top = y + 70 + "px"; // 70px is an offset to place it higher

            const flame = document.createElement("div");
            flame.className = "flame";
            candle.appendChild(flame);

            cake.appendChild(candle);
            candles.push(candle);
            updateCandleCount();
        });

        // 2. Handle File Upload
        audioUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const fileURL = URL.createObjectURL(file);
                birthdayMessageAudio.src = fileURL;
                audioStatus.textContent = `Audio ready: ${file.name}`;
            } else {
                audioStatus.textContent = 'No audio uploaded.';
            }
        });

        // 3. Main Microphone Setup
        startButton.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                const microphoneSource = audioContext.createMediaStreamSource(stream);
                microphoneSource.connect(analyser);

                analyser.fftSize = 256; 
                
                micStatus.textContent = "Microphone ON. Click cake to add candles!";
                startButton.style.display = 'none';
                backgroundMusic.play().catch(e => console.log("Music auto-play blocked."));
                detectBlow(); // Start the blow detection loop
            } catch (err) {
                micStatus.textContent = "Mic access denied. Cannot blow out candles.";
                console.error("Error accessing microphone:", err);
            }
        });


        // 4. Blow Detection Loop
        function detectBlow() {
            if (!analyser) {
                requestAnimationFrame(detectBlow);
                return;
            }
            
            requestAnimationFrame(detectBlow); 

            const volumeData = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(volumeData);
            let sum = 0;
            for (let i = 0; i < volumeData.length; i++) {
                sum += volumeData[i];
            }
            const averageVolume = sum / volumeData.length;

            if (averageVolume > BLOW_THRESHOLD && !isBlowing) {
                isBlowing = true;
                blowStatus.style.display = 'block';
                
                // Find the first active candle (not 'out')
                const activeCandle = candles.find((c) => !c.classList.contains("out"));
                if (activeCandle) {
                    activeCandle.classList.add("out");
                    updateCandleCount(); // Check if all are out
                }
                
                // Cooldown period and UI reset
                setTimeout(() => { 
                    isBlowing = false; 
                    if (candles.filter(c => !c.classList.contains("out")).length > 0) {
                        // Only hide blow status if candles are left to blow
                        blowStatus.style.display = 'none'; 
                    }
                }, 1000); 
            }
        }
    </script>
</body>
</html>
